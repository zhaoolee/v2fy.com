---
title: ä¸€æ¬¡å€ŸåŠ©ChatGPTæŠµå¾¡æ¶æ„æ”»å‡»çš„ç»å†ï¼Œä¸ºä¸ªäººæœåŠ¡å™¨æ·»åŠ è‡ªåŠ¨é˜²å¾¡ç³»ç»Ÿfail2ban
tags:
- ä¸ªäººæˆé•¿
categories:
- æ‚è°ˆ
---

æˆ‘æœ‰ä¸€å°ä¸ªäººæœåŠ¡å™¨ï¼Œæ‰˜ç®¡ç€è‡ªå·±çš„WordPressç½‘ç«™ï¼Œä¹Ÿæ”¾äº†RustDeskè¿™ç§ç§æœ‰åŒ–çš„è¿œç¨‹æ¡Œé¢å·¥å…·ï¼Œæœ€è¿‘æˆ‘å‘ç°RustDeskç‰¹åˆ«å¡ï¼Œç™»å½•æœåŠ¡å™¨æ‰å‘ç°WordPressæ¶ˆè€—äº†å¤§é‡çš„èµ„æºå’Œå¸¦å®½


![Uploaded image](https://cdn.fangyuanxiaozhan.com/assets/1748842841550JHbGCiWh.png)

ç„¶åæˆ‘æŠŠç°è±¡ä¸¢ç»™äº†GPT4o, GPT4oè¦æ±‚æŸ¥çœ‹æˆ‘çš„Nginxæ—¥å¿—


![image-20250602134232283](https://cdn.fangyuanxiaozhan.com/assets/17488429551398wBrhQdb.png)

```
sudo tail -f /var/log/nginx/access.log
```

æˆ‘å°†æ—¥å¿—è´´ç»™gptåï¼Œgptå¿«é€Ÿåˆ†æäº†é—®é¢˜

![image-20250602134331920](https://cdn.fangyuanxiaozhan.com/assets/1748843013979XaS0XHhp.png)

## ä¸€ã€ ä½¿ç”¨ Nginx é™é€Ÿä¿æŠ¤ç™»å½•æ¥å£

ä¸ºäº†é¿å…ä¿ç•™ç ´è§£ï¼Œæˆ‘ä»¬éœ€è¦å¯¹wp-login.phpè¿›è¡Œé™æµ

### 1.1 ç¼–è¾‘ nginx.confï¼Œæ·»åŠ é™æµé…ç½®



![image-20250602151208740](https://cdn.fangyuanxiaozhan.com/assets/1748848330680TmBFC4wa.png)


åœ¨ `http {}` åŒºå—ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š



```
limit_req_zone $binary_remote_addr zone=login_zone:10m rate=5r/m;
```

è§£é‡Šå¦‚ä¸‹ï¼š

- `$binary_remote_addr`ï¼šæŒ‰ IP å»ºç«‹é™æµï¼›
- `login_zone:10m`ï¼šè®¾ç½®ä¸€ä¸ª 10MB å†…å­˜çš„é™æµåŒºåŸŸï¼›
- `rate=5r/m`ï¼šæ¯ä¸ª IP æ¯åˆ†é’Ÿæœ€å¤šå…è®¸ 5 æ¬¡è¯·æ±‚ã€‚

ğŸ“Œ **æ³¨æ„ï¼šå¿…é¡»å†™åœ¨ `http {}` å—ä¸­ï¼**

### 1.2 ä¿®æ”¹è™šæ‹Ÿä¸»æœºé…ç½®ï¼Œå¯ç”¨ç™»å½•é¡µé™é€Ÿ

```
location = /wp-login.php {
    limit_req zone=login_zone burst=3 nodelay;
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.2-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}
```

#### å‚æ•°è¯´æ˜ï¼š

- `burst=3`ï¼šæœ€å¤šå…è®¸ 3 ä¸ªçªå‘è¯·æ±‚ï¼›

- `nodelay`ï¼šè¶…å‡ºé™é¢ç«‹å³æ‹’ç»ï¼›

- å…¶ä½™å‚æ•°ä¸º PHP-FPM å¸¸è§„é…ç½®ã€‚

## äºŒã€å®Œæ•´çš„ Nginx é…ç½®ç¤ºä¾‹ï¼ˆv2fy.com.confï¼‰

ä¸ºæ–¹ä¾¿å‚è€ƒï¼Œè¿™æ˜¯ä¸€ä»½åŒ…å« HTTPSã€é™æµã€é˜²æ³¨å…¥ã€é™æ€ç¼“å­˜ç­‰åŠŸèƒ½çš„å®Œæ•´ Nginx é…ç½® `v2fy.com.conf` ï¼š

```
# ç›‘å¬ HTTP ç«¯å£ï¼Œå°†æ‰€æœ‰è¯·æ±‚é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name v2fy.com;

    location / {
        return 301 https://$host$request_uri;  # æ°¸ä¹…é‡å®šå‘åˆ° HTTPS
    }
}

# ä¸»ç«™ç‚¹çš„ HTTPS é…ç½®
server {
    listen 443 ssl;
    server_name v2fy.com;

    # ç½‘ç«™æ ¹ç›®å½•
    root /usr/share/nginx/v2fy.com;
    index index.php index.html index.htm;

    # SSL è¯ä¹¦é…ç½®ï¼ˆè·¯å¾„æ ¹æ®ä½ å®é™…è¯ä¹¦æ–‡ä»¶å¡«å†™ï¼‰
    ssl_certificate /etc/nginx/ssl/v2fy.com/fullchain.cer;
    ssl_certificate_key /etc/nginx/ssl/v2fy.com/v2fy.com.key;

    # å®‰å…¨ç›¸å…³çš„ SSL è®¾ç½®
    ssl_session_timeout 5m;                 # ä¼šè¯ç¼“å­˜æ—¶é—´
    ssl_protocols TLSv1.2 TLSv1.3;          # ç¦ç”¨ä¸å®‰å…¨çš„ TLSv1 å’Œ TLSv1.1
    ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers on;

    # å¯ç”¨ gzip å‹ç¼©ï¼Œæé«˜é¡µé¢åŠ è½½é€Ÿåº¦
    gzip on;
    gzip_min_length 1k;
    gzip_buffers 4 16k;
    gzip_comp_level 8;
    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php;
    gzip_vary off;

    # é˜²æŠ¤ XMLRPC æ¥å£ï¼ˆæ”»å‡»é¢‘å‘ï¼‰
    location = /xmlrpc.php {
        limit_req zone=xmlrpc_zone burst=5 nodelay;  # å¯ç”¨é€Ÿç‡é™åˆ¶ï¼ˆéœ€åœ¨ http{} ä¸­å®šä¹‰ xmlrpc_zoneï¼‰
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;  # PHP-FPM socket è·¯å¾„
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        # access_log é»˜è®¤ä¸ºå¼€å¯ï¼ŒFail2Ban å¯ä»¥ç›‘æ§
    }

    # ç™»å½•é¡µé™é€Ÿï¼Œä¿æŠ¤ç™»å½•æš´åŠ›ç ´è§£
    location = /wp-login.php {
        limit_req zone=login_zone burst=3 nodelay;
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # Feed æ¥å£é™é€Ÿï¼Œé˜²æ­¢çˆ¬è™«æ»¥ç”¨
    location = /feed {
        limit_req zone=feed_zone burst=3 nodelay;
    }

    # å±è”½ä¼ª WordPress UA å‘èµ·çš„ cron è¯·æ±‚
    location = /wp-cron.php {
        if ($http_user_agent ~* "WordPress/") {
            return 403;
        }
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # ä¼˜åŒ– favicon è¯·æ±‚ï¼ˆé¿å… 404 æ—¥å¿—ï¼‰
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    # å…è®¸ robots.txt è¢«æœç´¢å¼•æ“è®¿é—®
    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    # ç¼“å­˜å¸¸è§é™æ€èµ„æºï¼Œå‡å°‘å¸¦å®½å’ŒæœåŠ¡å™¨å‹åŠ›
    location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
        expires max;            # æµè§ˆå™¨ç¼“å­˜æ—¶é—´æœ€é•¿
        log_not_found off;
        access_log off;
    }

    # ç½‘ç«™ä¸»é¡µåŠæ‰€æœ‰ URL è·¯ç”±å¤„ç†ï¼ˆWordPress rewriteï¼‰
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # PHP æ–‡ä»¶å¤„ç†è§„åˆ™ï¼ˆfastcgiï¼‰
    location ~ \.php$ {
        try_files $uri =404;    # ä¸å­˜åœ¨çš„æ–‡ä»¶ç›´æ¥è¿”å› 404
        include fastcgi_params;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # åå‘ä»£ç†æŸä¸ªæ¥å£ï¼ˆå¦‚ /wemessage/ï¼‰
    location /wemessage/ {
        proxy_pass http://127.0.0.1:3600;  # åä»£æœ¬åœ°ç«¯å£
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # é˜²æ­¢æ”»å‡»è€…æ„é€ ç‰¹å®šè·¯å¾„å‘èµ·è¯·æ±‚
    if ($request_uri ~* "(appendChild|postLinks|defer|actionURL)") {
        return 403;
    }

}

```





æˆ‘ä»¬å°†é…ç½®ä¸¢ç»™ChatGPT ï¼Œç»§ç»­è¿›è¡Œå®‰å…¨å¢å¼ºã€‚

![image-20250602140620846](https://cdn.fangyuanxiaozhan.com/assets/17488444135444NWAFCi1.png)



## ä¸‰ã€è¿›ä¸€æ­¥å¼ºåŒ–ï¼šå¯ç”¨ Fail2Ban æ‹‰é»‘æ¶æ„ IP

ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å¯¹æ¶æ„è¯·æ±‚è¿›è¡Œé™é€Ÿï¼Œé™é€Ÿå¯ä»¥ç¼“è§£æ”»å‡»ï¼Œä½†æ— æ³•å½»åº•æ‹¦æˆªæŒç»­æ‰«æçš„æ¶æ„ IPã€‚æ­¤æ—¶å¯å€ŸåŠ© Fail2Ban å®ç°è‡ªåŠ¨å°ç¦ã€‚



### 3.1 ä»€ä¹ˆæ˜¯ Fail2ban ?

`fail2ban` æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„å¼€æºå®‰å…¨å·¥å…·ï¼Œ**ä¸»è¦åŠŸèƒ½æ˜¯è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿæ—¥å¿—ä¸­çš„å¯ç–‘è¡Œä¸ºï¼ˆå¦‚æš´åŠ›ç ´è§£ã€æ¶æ„è¯·æ±‚ï¼‰å¹¶ä¸´æ—¶å°ç¦æ”»å‡»è€…çš„ IP åœ°å€**ï¼Œä»è€Œæé«˜æœåŠ¡å™¨çš„å®‰å…¨æ€§ã€‚



| åŠŸèƒ½                      | è¯´æ˜                                                         |
| ------------------------- | ------------------------------------------------------------ |
| **é˜²æ­¢ SSH æš´åŠ›ç ´è§£**     | å¦‚æœæŸä¸ª IP å¤šæ¬¡å°è¯•ç™»å½• SSH å¯†ç å¤±è´¥ï¼Œä¼šè¢«å°ç¦ã€‚            |
| **å°ç¦ Nginx/Web æ”»å‡»è€…** | åˆ†æè®¿é—®æ—¥å¿—ï¼Œå¦‚å‘ç°é¢‘ç¹ 403/404 è¯·æ±‚æˆ–æ¶æ„ URLï¼Œå°±å°ç¦å¯¹åº” IPã€‚ |
| **çµæ´»å¯é…ç½®**            | å¯è‡ªå®šä¹‰è§„åˆ™ã€å°ç¦æ—¶é•¿ã€é˜ˆå€¼ã€ç›‘æ§å“ªäº›æ—¥å¿—æ–‡ä»¶ç­‰ã€‚           |
| **è‡ªåŠ¨è§£å°**              | æ”¯æŒè®¾ç½®å°ç¦æ—¶é—´ï¼Œæ¯”å¦‚å° 10 åˆ†é’Ÿåè‡ªåŠ¨è§£å°ã€‚                 |



###  3.2  Fail2banå·¥ä½œåŸç†ï¼ˆç®€åŒ–æµç¨‹ï¼‰ï¼š

1. **ç›‘æ§æ—¥å¿—æ–‡ä»¶**ï¼ˆå¦‚ `/var/log/nginx/access.log` æˆ– `/var/log/auth.log`ï¼‰
2. **åŒ¹é…ç‰¹å®šçš„è¡Œä¸º**ï¼ˆæ¯”å¦‚ 5 åˆ†é’Ÿå†…å¤±è´¥ç™»å½• 5 æ¬¡ã€è®¿é—®ç‰¹å®šæ¶æ„è·¯å¾„ç­‰ï¼‰
3. **æ‰§è¡ŒåŠ¨ä½œ**ï¼šé»˜è®¤æ˜¯ `iptables` å° IPï¼Œä¹Ÿå¯å‘é‚®ä»¶æˆ–æ‰§è¡Œä½ è‡ªå®šä¹‰çš„å‘½ä»¤



## å››ï¼šé…ç½® Fail2Ban ä¿æŠ¤ Nginx

### 4.1 å®‰è£…Fail2ban



```
# æ›´æ¢å›½å†…é•œåƒæºï¼ˆå¯é€‰ï¼‰
sudo sed -i 's|http://archive.ubuntu.com/ubuntu|https://mirrors.tuna.tsinghua.edu.cn/ubuntu|g' /etc/apt/sources.list
# æ›´æ–°è½¯ä»¶åŒ…ç´¢å¼•å¹¶å®‰è£…
sudo apt update
sudo apt install fail2ban -y
```



### 4.2 æŸ¥çœ‹fail2banå·¥ä½œçŠ¶æ€



```
sudo systemctl status fail2ban
```



### 4.3 åŸºäºé»˜è®¤é…ç½®æ–‡ä»¶ï¼Œæ–°å»ºæœ¬åœ°é…ç½®æ–‡ä»¶



```
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
```


åœ¨é…ç½®æ–‡ä»¶`/etc/fail2ban/jail.local`æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹

```
[nginx-bad-requests]
enabled = true
port    = http,https
filter  = nginx-bad-requests
logpath = /var/log/nginx/access.log
maxretry = 5
findtime = 600
bantime = 3600
```

- `maxretry = 5`ï¼š10 åˆ†é’Ÿå†…å‡ºç° 5 æ¬¡åŒ¹é…å°±å°ç¦
- `bantime = 3600`ï¼šå°ç¦ 1 å°æ—¶
- `logpath`ï¼šä½ çš„ nginx æ—¥å¿—è·¯å¾„ï¼Œå¯ä»¥æ ¹æ®å®é™…è°ƒæ•´



### 4.4 åˆ›å»ºè¿‡æ»¤å™¨è§„åˆ™



```
sudo vim /etc/fail2ban/filter.d/nginx-bad-requests.conf
```



åœ¨æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹

```
[Definition]
failregex = <HOST> -.*"(GET|POST).*?(appendChild|postLinks|defer|actionURL).*HTTP.*"
ignoreregex =
```



### 4.5 é‡å¯Fail2ban

```
sudo systemctl restart fail2ban
```

æŸ¥çœ‹ `nginx-bad-requests` è§„åˆ™å°ç¦äº†å¤šå°‘IP

```
sudo fail2ban-client status nginx-bad-requests
```


![image-20250602143447680](https://cdn.fangyuanxiaozhan.com/assets/1748850533805KteNxPhp.png)

æˆ‘ä»¬æ‹‰é•¿æ—¶é—´æ®µï¼Œå‘ç°è¢«bançš„IPåœ¨é€æ¸å¢åŠ ï¼ˆä»19ä¸ªIPå¢åŠ åˆ°äº†33ä¸ªï¼‰

![image-20250602154654662](https://cdn.fangyuanxiaozhan.com/assets/1748850416139pmB0H5Fr.png)

æœåŠ¡å™¨çš„çŠ¶æ€ä¹Ÿå›å½’åˆ°äº†æ­£å¸¸çš„æ°´å¹³

![image-20250602154840553](https://cdn.fangyuanxiaozhan.com/assets/1748850522613wp341Rzm.png)


## æ€»ç»“

æœ¬æ–‡å€ŸåŠ© ChatGPT çš„å»ºè®®ï¼Œæˆ‘ä»¬å¿«é€Ÿè¯Šæ–­ Nginx æ—¥å¿—ä¸­çš„æ¶æ„è¯·æ±‚ï¼›åˆ©ç”¨ Nginx é…ç½®å®ç°æ¥å£é™é€Ÿï¼›å¼•å…¥ Fail2Ban å®ç°åŠ¨æ€å°ç¦äº†33ä¸ªæ¶æ„IPï¼Œè®©ä¸ªäººæœåŠ¡å™¨æ¢å¤æ­£å¸¸ã€‚

å€ŸåŠ© AI å’Œè‡ªåŠ¨åŒ–å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ›´ä½çš„æˆæœ¬ï¼Œä¿è¯æœåŠ¡å™¨çš„å®‰å…¨ï¼Œä¼˜ç§€çš„è¿ç»´å·¥ç¨‹å¸ˆï¼Œä¹Ÿæ˜¯å–„ç”¨å„ç±»å·¥å…·ï¼Œæå‡æœåŠ¡å™¨çš„ç¨³å®šæ€§ï¼ŒAIæŠ€æœ¯çš„è¿›æ­¥ï¼Œè®©å¹¶ä¸ä¸“ç²¾çš„è¿ç»´çš„å¼€å‘è€…ï¼Œä¹Ÿèƒ½å¿«é€Ÿæ‰¾åˆ°åˆé€‚å·¥å…·ï¼ŒåŠ å›ºä¸ªäººæœåŠ¡å™¨ï¼Œé¿å…ä¸å¿…è¦çš„æµé‡å’Œç®—åŠ›æµªè´¹ã€‚
